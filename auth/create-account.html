<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PEPSVAL — Create account</title>

  <!-- Uses same futuristic look as login -->
  <link rel="stylesheet" href="/auth/create-account.css?v=9999" />
</head>

<body>
  <div class="bgFX" aria-hidden="true"></div>

  <main class="wrap">
    <section class="card">
      <div class="brand">
        <div class="name">PEPSVAL</div>
        <div class="tag">connect, hire and grow</div>
      </div>

      <h1 class="title">Create your account</h1>
      <p class="sub">Your data is private. Nothing is shared without your permission.</p>

      <form id="createForm" novalidate>
        <div class="field">
          <div class="label"><span>Email</span></div>
          <input id="email" type="email" placeholder="you@example.com" autocomplete="email" required />
        </div>

        <div class="field">
          <div class="label"><span>Password</span></div>
          <div class="inputRow">
            <input id="password" type="password" placeholder="Create a password" autocomplete="new-password" required />
            <button type="button" class="toggleBtn" id="togglePw">Show</button>
          </div>
        </div>

        <div class="field">
          <div class="label"><span>Confirm password</span></div>
          <input id="confirmPassword" type="password" placeholder="Repeat your password" autocomplete="new-password" required />
        </div>

        <div id="errorBox" class="msg error" style="display:none;"></div>
        <div id="successBox" class="msg success" style="display:none;"></div>

        <button class="btn" id="createBtn" type="submit">Create account</button>

        <div class="links">
          <a href="/auth/login.html">Back to login</a>
          <a href="/auth/forgot.html">Forgot password?</a>
        </div>

        <div class="legal">
          By continuing, you agree to our
          <a href="/legal/terms.html" target="_blank" rel="noopener">Terms</a>
          and
          <a href="/legal/privacy.html" target="_blank" rel="noopener">Privacy Policy</a>.
        </div>
      </form>
    </section>
  </main>

  <script>
    // Password toggle UI
    const pw = document.getElementById("password");
    const tbtn = document.getElementById("togglePw");
    tbtn.addEventListener("click", () => {
      const isPw = pw.type === "password";
      pw.type = isPw ? "text" : "password";
      tbtn.textContent = isPw ? "Hide" : "Show";
    });
  </script>

  <!-- BULLETPROOF MODULE: runs even if external JS paths were wrong -->
  <script type="module">
    const form = document.getElementById("createForm");
    const errorBox = document.getElementById("errorBox");
    const successBox = document.getElementById("successBox");
    const btn = document.getElementById("createBtn");

    const show = (el, msg) => { el.style.display="block"; el.textContent=msg; };
    const hide = (el) => { el.style.display="none"; el.textContent=""; };

    // Catch ANY crash and show it on screen (no silent failure)
    window.addEventListener("error", (e) => {
      hide(successBox);
      show(errorBox, "JS error: " + (e?.message || "Unknown error"));
    });

    window.addEventListener("unhandledrejection", (e) => {
      hide(successBox);
      show(errorBox, "Promise error: " + (e?.reason?.message || e?.reason || "Unknown error"));
    });

    // Load Supabase safely
    let supabase;
    try {
      const mod = await import("/js/supabase.js");
      supabase = mod.supabase;
      if (!supabase) throw new Error("supabase export missing in /js/supabase.js");
    } catch (err) {
      show(errorBox, "Cannot load Supabase: " + (err?.message || err));
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      hide(errorBox);
      hide(successBox);

      if (!supabase) {
        show(errorBox, "Supabase not ready. Check /js/supabase.js SUPABASE_URL + ANON_KEY.");
        return;
      }

      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;
      const confirm = document.getElementById("confirmPassword").value;

      if (!email) return show(errorBox, "Please enter your email.");
      if (!password) return show(errorBox, "Please enter a password.");
      if (password.length < 6) return show(errorBox, "Password must be at least 6 characters.");
      if (password !== confirm) return show(errorBox, "Passwords do not match.");

      btn.disabled = true;
      btn.textContent = "Creating…";

      try {
        // MUST be added in Supabase Redirect URLs
        const emailRedirectTo = `${location.origin}/auth/login.html`;

        const { data, error } = await supabase.auth.signUp({
          email,
          password,
          options: { emailRedirectTo }
        });

        if (error) {
          show(errorBox, error.message || "Create account failed.");
          return;
        }

        // If email confirmations ON -> session is null
        if (!data?.session) {
          show(successBox, "Account created ✅ Check your email to confirm, then login.");
          return;
        }

        // If confirmations OFF -> session exists
        window.location.href = "/setup/profile-setup.html";
      } catch (err) {
        show(errorBox, err?.message || "Unexpected error. Please try again.");
      } finally {
        btn.disabled = false;
        btn.textContent = "Create account";
      }
    });
  </script>
</body>
</html>
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PEPSVAL — Forgot password</title>

  <link rel="stylesheet" href="/auth/forgot.css?v=9999" />
</head>

<body>
  <div class="bgFX" aria-hidden="true"></div>

  <main class="wrap">
    <section class="card">
      <div class="brand">
        <div class="name">PEPSVAL</div>
        <div class="tag">connect, hire and grow</div>
      </div>

      <h1 class="title">Reset your password</h1>
      <p class="sub">Enter your email. We’ll send a secure reset link.</p>

      <form id="forgotForm" novalidate>
        <div class="field">
          <div class="label"><span>Email</span></div>
          <input id="email" type="email" placeholder="you@example.com" autocomplete="email" required />
        </div>

        <div id="errorBox" class="msg error" style="display:none;"></div>
        <div id="successBox" class="msg success" style="display:none;"></div>

        <button class="btn" id="sendBtn" type="submit">Send reset link</button>

        <div class="links">
          <a href="/auth/login.html">Back to login</a>
          <a href="/create-account.html">Create account</a>
        </div>

        <div class="legal">
          <a href="/legal/privacy.html" target="_blank" rel="noopener">Privacy</a>
          ·
          <a href="/legal/terms.html" target="_blank" rel="noopener">Terms</a>
        </div>
      </form>
    </section>
  </main>

  <script type="module">
    const form = document.getElementById("forgotForm");
    const errorBox = document.getElementById("errorBox");
    const successBox = document.getElementById("successBox");
    const btn = document.getElementById("sendBtn");

    const show = (el, msg) => { el.style.display="block"; el.textContent=msg; };
    const hide = (el) => { el.style.display="none"; el.textContent=""; };

    window.addEventListener("error", (e) => {
      hide(successBox);
      show(errorBox, "JS error: " + (e?.message || "Unknown error"));
    });

    window.addEventListener("unhandledrejection", (e) => {
      hide(successBox);
      show(errorBox, "Promise error: " + (e?.reason?.message || e?.reason || "Unknown error"));
    });

    let supabase;
    try {
      const mod = await import("/js/supabase.js");
      supabase = mod.supabase;
      if (!supabase) throw new Error("supabase export missing in /js/supabase.js");
    } catch (err) {
      show(errorBox, "Cannot load Supabase: " + (err?.message || err));
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      hide(errorBox);
      hide(successBox);

      if (!supabase) {
        show(errorBox, "Supabase not ready. Check /js/supabase.js SUPABASE_URL + ANON_KEY.");
        return;
      }

      const email = document.getElementById("email").value.trim();
      if (!email) return show(errorBox, "Please enter your email.");

      btn.disabled = true;
      btn.textContent = "Sending…";

      try {
        // MUST be added in Supabase Redirect URLs
        const redirectTo = `${location.origin}/reset.html`;

        const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo });

        if (error) {
          show(errorBox, error.message || "Could not send reset email.");
          return;
        }

        show(successBox, "Reset link sent ✅ Check inbox/spam.");
      } catch (err) {
        show(errorBox, err?.message || "Unexpected error. Please try again.");
      } finally {
        btn.disabled = false;
        btn.textContent = "Send reset link";
      }
    });
  </script>
</body>
</html>